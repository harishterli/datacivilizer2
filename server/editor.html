OCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DC2 Editor</title>
    <meta name="description"
          content="Drag a link to reconnect it. Nodes have custom Adornments for selection, resizing, and rotating.  The Palette includes links."/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Copyright 1998-2019 by Northwoods Software Corporation. -->
    <script src="/go.js"></script>
    <script src="/Figures.js"></script>
    <script src="/dragscroll.js"></script>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel='stylesheet' href='/DataInspector.css'/>
    <script src="/visualizerUtils.js"></script>
    <script src="/debuggerUtils.js"></script>
    <script src="/trackingUtils.js"></script>
    <script src="/DataInspector.js"></script>
    <script src="/ejs_production.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script id="code">

        var source = new EventSource('./registerEditor');

        source.onmessage = function (event) {
            console.log(JSON.parse(event.data).data);
        };

        source.addEventListener('split_update', (e) => {
            update_running_pipeline(JSON.parse(event.data));
        });

        source.addEventListener('tracking_update', (e) => {
            add_tracking_ids(JSON.parse(event.data));
        });

        source.addEventListener('finish_run', (e) => {
            finish_running_pipeline(JSON.parse(event.data));
        });

        function iFrameJsonParams() {
            var iFrameWidthString = localStorage.getItem("widthLocalStorage");
            var iFrameHeightString = localStorage.getItem("heightLocalStorage");
            var iFrameWidthNumber = Number(iFrameWidthString);
            var iFrameHeightNumber = Number(iFrameHeightString) + 10;
            document.getElementById('iframeViz').style.width = iFrameWidthNumber + 'px';
            document.getElementById('iframeViz').style.height = iFrameHeightNumber + 'px';
        };

        function iFrameImageParams() {
            var iframe = document.getElementById('iframeViz');
            var innerDoc = iframe.contentWindow.document;
            var myRegexp = /.+\s(\d+)\s.\s(\d+)/;
            var match = myRegexp.exec(innerDoc.title);
            document.getElementById('iframeViz').style.width = Number(match[1]);
            document.getElementById('iframeViz').style.height = Number(match[2]);
        };

        var running_models = []
        var models = {};
        var modules_info;
        var filter_parameters = [];
        var filter_metrics = [];

        function init() {

            if (window.goSamples) goSamples(); // init for these samples -- you don't need to call this
            var GOJS = go.GraphObject.make; // for conciseness in defining templates

            go.licenseKey = "54f041e0b11c28c702d90776423d6bf919a57a63c8841aa30e0442f6b9086d1c249dee6a41d5dc90d7f81baf4a2995dbdec56a7992495132e43480de16e286fee7347aa0040e12dea203749398e83aa2fd7879edc7aa77a5";

            myDiagram =
                GOJS(go.Diagram, "myDiagramDiv", // must name or refer to the DIV HTML element
                    {
                        "draggingTool.dragsLink": true,
                        "draggingTool.isGridSnapEnabled": false,
                        "linkingTool.isUnconnectedLinkValid": false,
                        "linkingTool.portGravity": 20,
                        "relinkingTool.isUnconnectedLinkValid": true,
                        "relinkingTool.portGravity": 20,
                        "relinkingTool.fromHandleArchetype": GOJS(go.Shape, "Diamond", {
                            segmentIndex: 0,
                            cursor: "pointer",
                            desiredSize: new go.Size(8, 8),
                            fill: "tomato",
                            stroke: "darkred"
                        }),
                        "relinkingTool.toHandleArchetype": GOJS(go.Shape, "Diamond", {
                            segmentIndex: -1,
                            cursor: "pointer",
                            desiredSize: new go.Size(8, 8),
                            fill: "darkred",
                            stroke: "tomato"
                        }),
                        "linkReshapingTool.handleArchetype": GOJS(go.Shape, "Diamond", {
                            desiredSize: new go.Size(7, 7),
                            fill: "lightblue",
                            stroke: "deepskyblue"
                        }),
                        "rotatingTool.handleAngle": 270,
                        "rotatingTool.handleDistance": 30,
                        "rotatingTool.snapAngleMultiple": 15,
                        "rotatingTool.snapAngleEpsilon": 15,
                        "undoManager.isEnabled": true
                    });

            myDiagram.allowTextEdit = false;


            // when the document is modified, add a "*" to the title and enable the "Save" button
            myDiagram.addDiagramListener("Modified", function (e) {
                var button = document.getElementById("SaveButton");
                if (button) button.disabled = !myDiagram.isModified;
                var idx = document.title.indexOf("*");
                if (myDiagram.isModified) {
                    if (idx < 0) document.title += "*";
                } else {
                    if (idx >= 0) document.title = document.title.substr(0, idx);
                }
            });

            // Define a function for creating a "port" that is normally transparent.
            // The "name" is used as the GraphObject.portId, the "spot" is used to control how links connect
            // and where the port is positioned on the node, and the boolean "output" and "input" arguments
            // control whether the user can draw links from or to the port.
            function makePort(name, spot, output, input) {
                // the port is basically just a small transparent square
                return GOJS(go.Shape, "Circle", {
                    fill: null, // not seen, by default; set to a translucent gray by showSmallPorts, defined below
                    stroke: null,
                    desiredSize: new go.Size(7, 7),
                    alignment: spot, // align the port on the main Shape
                    alignmentFocus: spot, // just inside the Shape
                    portId: name, // declare this object to be a "port"
                    fromSpot: spot,
                    toSpot: spot, // declare where links may connect at this port
                    fromLinkable: output,
                    toLinkable: input, // declare whether the user may draw links to/from here
                    cursor: "pointer" // show a different cursor to indicate potential link point
                });
            }

            var nodeSelectionAdornmentTemplate =
                GOJS(go.Adornment, "Auto",
                    GOJS(go.Shape, {fill: null, stroke: "deepskyblue", strokeWidth: 1.5, strokeDashArray: [4, 2]}),
                    GOJS(go.Placeholder)
                );

            var nodeResizeAdornmentTemplate =
                GOJS(go.Adornment, "Spot", {locationSpot: go.Spot.Right},
                    GOJS(go.Placeholder),
                    GOJS(go.Shape, {
                        alignment: go.Spot.TopLeft,
                        cursor: "nw-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),
                    GOJS(go.Shape, {
                        alignment: go.Spot.Top,
                        cursor: "n-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),
                    GOJS(go.Shape, {
                        alignment: go.Spot.TopRight,
                        cursor: "ne-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),

                    GOJS(go.Shape, {
                        alignment: go.Spot.Left,
                        cursor: "w-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),
                    GOJS(go.Shape, {
                        alignment: go.Spot.Right,
                        cursor: "e-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),

                    GOJS(go.Shape, {
                        alignment: go.Spot.BottomLeft,
                        cursor: "se-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),
                    GOJS(go.Shape, {
                        alignment: go.Spot.Bottom,
                        cursor: "s-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),
                    GOJS(go.Shape, {
                        alignment: go.Spot.BottomRight,
                        cursor: "sw-resize",
                        desiredSize: new go.Size(6, 6),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    })
                );

            var nodeRotateAdornmentTemplate =
                GOJS(go.Adornment, {locationSpot: go.Spot.Center, locationObjectName: "CIRCLE"},
                    GOJS(go.Shape, "Circle", {
                        name: "CIRCLE",
                        cursor: "pointer",
                        desiredSize: new go.Size(7, 7),
                        fill: "lightblue",
                        stroke: "deepskyblue"
                    }),
                    GOJS(go.Shape, {
                        geometryString: "M3.5 7 L3.5 30",
                        isGeometryPositioned: true,
                        stroke: "deepskyblue",
                        strokeWidth: 1.5,
                        strokeDashArray: [4, 2]
                    })
                );


            myDiagram.nodeTemplate =
                GOJS(go.Node, "Spot", {locationSpot: go.Spot.Center},
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify), {
                        selectable: true,
                        selectionAdornmentTemplate: nodeSelectionAdornmentTemplate
                    }, {
                        resizable: true,
                        resizeObjectName: "PANEL",
                        resizeAdornmentTemplate: nodeResizeAdornmentTemplate
                    }, {rotatable: true, rotateAdornmentTemplate: nodeRotateAdornmentTemplate},
                    new go.Binding("angle").makeTwoWay(),
                    // the main object is a Panel that surrounds a TextBlock with a Shape
                    GOJS(go.Panel, "Auto", {name: "PANEL"}, {desiredSize: new go.Size(120, 40)},
                        GOJS(go.Shape, "Rectangle", // default figure
                            {
                                portId: "", // the default port: if no spot on link data, use closest side
                                fromLinkable: true,
                                toLinkable: true,
                                cursor: "pointer",
                                fill: "white", // default color
                                strokeWidth: 2
                            },
                            new go.Binding("figure"),
                            new go.Binding("fill")),
                        GOJS(go.TextBlock, {
                                font: "bold 11pt Helvetica, Arial, sans-serif",
                                margin: 8,
                                maxSize: new go.Size(160, NaN),
                                wrap: go.TextBlock.WrapFit,
                                editable: true
                            },
                            new go.Binding("text").makeTwoWay())
                    ),
                    // four small named ports, one on each side:
                    makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("B", go.Spot.Bottom, true, false), { // handle mouse enter/leave events to show/hide the ports
                        mouseEnter: function (e, node) {
                            showSmallPorts(node, true);
                        },
                        mouseLeave: function (e, node) {
                            showSmallPorts(node, false);
                        }
                    }, {
                        contextMenu: // define a context menu for each node
                            GOJS("ContextMenu", // that has one button
                                // GOJS("ContextMenuButton",
                                //     GOJS(go.TextBlock, "Download input"), {click: requestOutputFile}
                                // ),
                                GOJS("ContextMenuButton",
                                    GOJS(go.TextBlock, "Download output"), {click: requestOutputFile}
                                ),
                                // GOJS("ContextMenuButton",
                                //     GOJS(go.TextBlock, "Visualize input")
                                // ),
                                GOJS("ContextMenuButton",
                                    GOJS(go.TextBlock, "Visualize output", {click: visualizeOutput})
                                ),

                                // more ContextMenuButtons would go here
                            ) // end Adornment
                    }
                );


            myDiagram.add(
                GOJS(go.Part,
                    GOJS(go.Picture, "fig.png", {background: "gray", width: 50, height: 50})
                ));


            function showSmallPorts(node, show) {
                node.ports.each(function (port) {
                    if (port.portId !== "") { // don't change the default port, which is the big shape
                        port.fill = show ? "rgba(0,0,0,.3)" : null;
                    }
                });
            }

            var linkSelectionAdornmentTemplate =
                GOJS(go.Adornment, "Link",
                    GOJS(go.Shape,
                        // isPanelMain declares that this Shape shares the Link.geometry
                        {isPanelMain: true, fill: null, stroke: "deepskyblue", strokeWidth: 0}) // use selection object's strokeWidth
                );

            myDiagram.linkTemplate =
                GOJS(go.Link, // the whole link panel
                    {
                        selectable: true,
                        selectionAdornmentTemplate: linkSelectionAdornmentTemplate
                    }, {relinkableFrom: true, relinkableTo: true, reshapable: true}, {
                        routing: go.Link.AvoidsNodes,
                        curve: go.Link.JumpOver,
                        corner: 5,
                        toShortLength: 4
                    },
                    new go.Binding("points").makeTwoWay(),
                    GOJS(go.Shape, // the link path shape
                        {isPanelMain: true, strokeWidth: 2}),
                    GOJS(go.Shape, // the arrowhead
                        {toArrow: "Standard", stroke: null}),
                    GOJS(go.Panel, "Auto",
                        new go.Binding("visible", "isSelected").ofObject(),
                        GOJS(go.Shape, "RoundedRectangle", // the link shape
                            {fill: "#F8F8F8", stroke: null}),
                        GOJS(go.TextBlock, {
                                textAlign: "center",
                                font: "10pt helvetica, arial, sans-serif",
                                stroke: "#919191",
                                margin: 2,
                                minSize: new go.Size(10, NaN),
                                editable: true
                            },
                            new go.Binding("text").makeTwoWay())
                    )
                );

            var inspector = new Inspector('myInspectorDiv', myDiagram, {
                // allows for multiple nodes to be inspected at once
                multipleSelection: false,
                // max number of node properties will be shown when multiple selection is true
                showSize: 1,
                // when multipleSelection is true, when showAllProperties is true it takes the union of properties
                // otherwise it takes the intersection of properties
                showAllProperties: false,
                // uncomment this line to only inspect the named properties below instead of all properties on each object:
                includesOwnProperties: true,
                properties: {
                    "text": {show: false},
                    // key would be automatically added for nodes, but we want to declare it read-only also:
                    "key": {show: false},
                    "figure": {show: false},
                    "loc": {show: false},
                    "fill": {show: false},
                    "cmd": {readOnly: true}
                    //"key": { readOnly: true, show: Inspector.showIfPresent },
                    // color would be automatically added for nodes, but we want to declare it a color also:
                    //"color": { show: Inspector.showIfPresent, type: 'color' },
                    // Comments and LinkComments are not in any node or link data (yet), so we add them here:
                    //"arg0": { show: Inspector.showIfNode }
                    //"LinkComments": { show: Inspector.showIfLink },
                    //"isGroup": { readOnly: true, show: Inspector.showIfPresent },
                    //"flag": { show: Inspector.showIfNode, type: 'checkbox' },
                    // "state": {
                    //   show: Inspector.showIfNode,
                    //   type: "select",
                    //   choices: function(node, propName) {
                    //     if (Array.isArray(node.data.choices)) return node.data.choices;
                    //     return ["one", "two", "three", "four", "five"];
                    //   }
                    // },
                    // "choices": { show: false },  // must not be shown at all
                    // // an example of specifying the <input> type
                    // "password": { show: Inspector.showIfPresent, type: 'password' }
                }
            });

            load(); // load an initial diagram from some JSON text

            // initialize the Palette that is on the left side of the page

            $.ajax({
                url: '/modules_info',
                type: 'get',
                success: function (data) {
                    contents = [];
                    for (var i in data) {
                        var obj = JSON.parse(data[i]);
                        var palette_elem = {
                            text: obj.name,
                            figure: "RoundedRectangle",
                            fill: "white",
                            cmd: obj.cmd
                        }
                        if (obj.cmd != "mod_source") {
                            palette_elem['splits'] = "";
                        }
                        for (var i = 0; i < obj.parameters.length; i++) {
                            var param = obj.parameters[i];
                            palette_elem[param.name] = param.default_value;
                        }
                        if ("color" in obj) {
                            palette_elem["fill"] = obj.color;
                            contents.splice(0, 0, palette_elem);
                        } else {
                            contents.push(palette_elem);
                        }
                    }
                    myPalette =
                        GOJS(go.Palette, "myPaletteDiv", // must name or refer to the DIV HTML element
                            {
                                maxSelectionCount: 1,
                                nodeTemplateMap: myDiagram.nodeTemplateMap, // share the templates used by myDiagram
                                linkTemplate: // simplify the link template, just in this Palette
                                    GOJS(go.Link, { // because the GridLayout.alignment is Location and the nodes have locationSpot == Spot.Center,
                                            // to line up the Link in the same manner we have to pretend the Link has the same location spot
                                            locationSpot: go.Spot.Center,
                                            selectionAdornmentTemplate: GOJS(go.Adornment, "Link", {locationSpot: go.Spot.Center},
                                                GOJS(go.Shape, {
                                                    isPanelMain: true,
                                                    fill: null,
                                                    stroke: "deepskyblue",
                                                    strokeWidth: 0
                                                }),
                                                GOJS(go.Shape, // the arrowhead
                                                    {toArrow: "Standard", stroke: null})
                                            )
                                        }, {
                                            routing: go.Link.AvoidsNodes,
                                            curve: go.Link.JumpOver,
                                            corner: 5,
                                            toShortLength: 4
                                        },
                                        new go.Binding("points"),
                                        GOJS(go.Shape, // the link path shape
                                            {isPanelMain: true, strokeWidth: 2}),
                                        GOJS(go.Shape, // the arrowhead
                                            {toArrow: "Standard", stroke: null})
                                    ),
                                model: new go.GraphLinksModel(contents/*[ // specify the contents of the Palette
                                    {
                                        text: "Data source",
                                        figure: "RoundedRectangle",
                                        fill: "lightgreen",
                                        cmd: "mod_source",
                                        path: "SampleData1.mat",
                                        splits: ""
                                    },
                                    {text: "Resample", figure: "RoundedRectangle", fill: "white", cmd: "mod_resample", resample_frequency: 200, splits: ""},
                                    {text: "Filter", figure: "RoundedRectangle", fill: "white", cmd: "mod_filter", notch_frequency: 60, high_pass_frequency: 0.5, low_pass_frequency: 40, splits: ""},
                                    {text: "Montage", figure: "RoundedRectangle", fill: "white", cmd: "mod_montage", montage_type: "monopolar", splits: ""},
                                    {text: "Clip", figure: "RoundedRectangle", fill: "white", cmd: "mod_clip", splits: ""},
                                    {text: "Spectogram", figure: "RoundedRectangle", fill: "white", cmd: "mod_spectrogram", nw: 2, splits: ""},
                                    {
                                        text: "EEG features",
                                        figure: "RoundedRectangle",
                                        fill: "white",
                                        cmd: "mod_computeFeatures",
                                        delta_low: 1,
                                        delta_high: 4,
                                        theta_low: 4,
                                        theta_high: 8,
                                        alpha_low: 8,
                                        alpha_high: 12,
                                        beta_low: 12,
                                        beta_high: 18,
                                        splits: ""
                                    },
                                    {text: "Change pts", figure: "RoundedRectangle", fill: "white", cmd: "mod_changePoints", threshold: 0.5, splits: ""},
                                    {
                                        text: "Binary seg",
                                        figure: "RoundedRectangle",
                                        fill: "white",
                                        cmd: "mod_binarySegmentation",
                                        splits: ""
                                    },
                                    {text: "BSP", figure: "RoundedRectangle", fill: "white", cmd: "mod_bsp", splits: ""},

                                ]*/)
                            });
                    myPalette.requestUpdate();
                }
            });
            load_models();
        };

        // Show the diagram's model in JSON format that the user may edit
        function save() {
            saveDiagramProperties(); // do this first, before writing to JSON
            document.getElementById("mySavedModel").value = myDiagram.model.toJson();
            myDiagram.isModified = false;
        };

        function load() {
            myDiagram.model = go.Model.fromJson(document.getElementById("mySavedModel").value);
            loadDiagramProperties(); // do this after the Model.modelData has been brought into memory
        };

        function load_diagram(model) {
            console.log("Loading diagram for model " + model.modelId);
            myDiagram.model = go.Model.fromJson(model);
            loadDiagramProperties(); // do this after the Model.modelData has been brought into memory
        };

        function saveDiagramProperties() {
            myDiagram.model.modelData.position = go.Point.stringify(myDiagram.position);
        };

        function loadDiagramProperties(e) {
            // set Diagram.initialPosition, not Diagram.position, to handle initialization side-effects
            var pos = myDiagram.model.modelData.position;
            if (pos) myDiagram.initialPosition = go.Point.parse(pos);
        };

        function requestOutputFile(e, obj) {
            console.log(obj.part.adornedPart.data.key);
            var node_key = obj.part.adornedPart.data.key;
            window.location = window.location.href + "download_output?" + node_key; //add "download..." to the URL (get)
        };

        function visualizeOutput(e, obj) {
            console.log(obj.part.adornedPart.data.key);
            var node_key = obj.part.adornedPart.data.key;
            var iframe = document.getElementById('iframeViz');
            var filename = "./Data/out_" + node_key + ".json";

            console.log("visualizing: " + filename);
            visualizeFile(filename);
        };

        function visualizeFile(filepath) {
            close_viz('edv_list_div')
            var extension = filepath.split('.').pop();
            if (extension == 'json') {
                visualizeJson(filepath);
            } else if (extension == 'jpg' || extension == 'png') {
                visualizeImage(filepath);
            } else if (extension == 'csv') {
                open_viz('edv_list_div')
                visualizeCsv(filepath)
            }
        };

        function visualizeCsv(filepath) {
            $('#edv_list').html("");
            console.log("visualizing: " + filepath);
            $.get('/csvVizList',
                {"pathCsv": filepath})
                .done(function (response) {
                    const l = response.list;
                    for (const elem of l){
                        var html = new EJS({url : '/edv_list_elem.ejs'}).render({'filepath': elem, 'prefix': filepath.replace('.csv', '') + '/'});
                        $('#edv_list').append($(html));
                    }
                });
        };

        function visualizeImage(filepath) {
            console.log("visualizing: " + filepath);
            var iframe = document.getElementById('iframeViz');
            $.get('/setImageViz',
                {"pathJSON": filepath})
                .done(function (response) {
                    iframe.setAttribute("src", "vizPicture");
                    iframe.src = iframe.src;
                    setTimeout(iFrameImageParams, 500);
                });
        };

        function visualizeJson(filepath) {
            console.log("visualizing: " + filepath);
            var iframe = document.getElementById('iframeViz');
            $.get('/setViz',
                {"pathJSON": filepath})
                .done(function (response) {
                    iframe.setAttribute("src", "vizFrame");
                    iframe.src = iframe.src;
                    setTimeout(iFrameJsonParams, 500);
                });
        };

        function request_pipeline(p) {

            console.log(p);

            $.ajax({
                url: '/request_pipeline',
                type: 'get',
                dataType: 'text',
                contentType: "text/plain",
                data: p,
                success: function (data) {
                    console.log("success!");
                    myDiagram.model = go.Model.fromJson(data);
                    loadDiagramProperties(); // do this after the Model.modelData has been brought into memory
                    document.getElementById("mySavedModel").value = myDiagram.model.toJson();
                }
            });
        };

        function open_viz(id) {
            var x = document.getElementById(id);
            if (x.className.indexOf("w3-show") == -1) {
                x.className = x.className.replace(" w3-hide", " w3-show");
            }
        };

        function close_viz(id) {
            var x = document.getElementById(id);
            if (x.className.indexOf("w3-hide") == -1) {
                x.className = x.className.replace(" w3-show", " w3-hide");
            }
        };

        function toggle_viz(id) {
            var x = document.getElementById(id);
            if (x.className.indexOf("w3-show") == -1) {
                x.className = x.className.replace(" w3-hide", " w3-show");
            } else {
                x.className = x.className.replace(" w3-show", " w3-hide");
            }
        };

        function toggle_arrow(id) {
            var x = document.getElementById(id);
            if (x.className.indexOf("fa-angle-up") == -1) {
                x.className = x.className.replace(" fa-angle-down", " fa-angle-up");
            } else {
                x.className = x.className.replace(" fa-angle-up", " fa-angle-down");
            }
        };

        function open_debugger() {
            var _debugger = document.getElementById('debugger');
            if (_debugger.className.indexOf("w3-show") == -1) {
                _debugger.className = _debugger.className.replace(" w3-hide", " w3-show");
            }
            var _diagram = document.getElementById("diagram");
            _diagram.style.width = "40%";
            myDiagram.requestUpdate();
        };

        function close_debugger() {
            var _debugger = document.getElementById('debugger');
            if (_debugger.className.indexOf("w3-hide") == -1) {
                _debugger.className = _debugger.className.replace(" w3-show", " w3-hide");
            }
            var _diagram = document.getElementById("diagram");
            _diagram.style.width = "80%";
            myDiagram.requestUpdate();
        };
    </script>
</head>

<body onload="init()">
<script src="/versioningUtils.js"></script>
<script type="text/javascript">

    var maxModelId = 0;

    var maxSize = 1000;
    var hashTable = new Array(maxSize);
    var runCounter = [];
    var newId = false;

    // saveModelVersions(); // Use this to reset hash table and model id's, preferrably destroy all saved models before

    getModelVersions();

    function send() {

        var debugger_type = document.querySelector('input[name="debug_type"]:checked').value;

        saveDiagramProperties();
        console.log(myDiagram.model.toJson());
        modelJsonString = myDiagram.model.toJson();

        modelHash = getHash(modelJsonString, maxSize);

        if (hashTable[modelHash] === undefined || hashTable[modelHash] === null) {
            modelId = maxModelId;
            maxModelId += 1;
            runNo = 1;
            hashTable[modelHash] = modelId;
            runCounter[modelId] = runNo;
        } else {
            modelId = hashTable[modelHash];
            runCounter[modelId] += 1;
            runNo = runCounter[modelId];
        }

        saveModelVersions();
        console.log(modelHash);
        console.log(modelId);
        console.log(runNo);

        modelJson = JSON.parse(modelJsonString);
        modelJson['modelId'] = modelId;
        modelJson['runNo'] = runNo;
        console.log(modelJson);
        modelJsonString = JSON.stringify(modelJson);
        saveModel(modelJsonString);

        tracking_filters = get_tracking_filters()

        data_to_send = {
            'pipeline': modelJson,
            'debugger_type': debugger_type,
            'tracking_filters': tracking_filters
        }

        $.ajax({
            url: '/run',
            type: 'post',
            processData: false,
            data: JSON.stringify(data_to_send),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                console.log("success!");
                add_model_to_debugger(data);
                open_debugger();
            }
        });
    };
</script>
<script>
    function handleFile(files) {
        const numFiles = files.length;
        console.log(numFiles);

        var fr = new FileReader();
        fr.onload = function (e) {
            data = e.target.result;
            myDiagram.model = go.Model.fromJson(data);
            loadDiagramProperties();  // do this after the Model.modelData has been brought into memory
            document.getElementById("mySavedModel").value = myDiagram.model.toJson();
        };
        fr.readAsText(files[0]);


    }

    function saveTextAsFile() {
        document.getElementById("mySavedModel").value = myDiagram.model.toJson();


        var pipeline_json = document.getElementById("mySavedModel").value;
        var json_as_blob = new Blob([pipeline_json], {type: "application/json"});
        var json_url = window.URL.createObjectURL(json_as_blob);
        var fname = document.getElementById("inputFileNameToSaveAs").value;


        var downloadLink = document.createElement("a");
        downloadLink.download = fname;
        downloadLink.innerHTML = "Download File";
        downloadLink.href = json_url;
        downloadLink.onclick = destroyClickedElement;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);

        downloadLink.click();
    }

    function destroyClickedElement(event) {
        document.body.removeChild(event.target);
    }

</script>
<style type="text/css" media="screen">
    #debugger_scrollmenu::-webkit-scrollbar { 
        display: none;
    }
    .ti::-webkit-scrollbar { 
        display: none;
    }
</style>

<div class="w3-top" style="z-index: 5">
    <div class="w3-bar w3-light-gray">
        <a class="w3-bar-item w3-green">Data Civilizer 2.0</a>
        <a class="w3-bar-item w3-button" onclick="open_viz('visualizer');document.getElementById('header_01').scrollIntoView({behavior: 'smooth'});">Saved Pipelines</a>
        <a class="w3-bar-item w3-button" onclick="open_viz('editor');document.getElementById('header_02').scrollIntoView({behavior: 'smooth'});">Pipeline editor</a>
        <a class="w3-bar-item w3-button" onclick="open_viz('output_viz');document.getElementById('header_03').scrollIntoView({behavior: 'smooth'});">Visualize output</a>
    </div>
</div>

<hr id="header_01">
<br>

<div class="w3-container">
    <button class="w3-button w3-block" onclick="toggle_viz('visualizer'); toggle_arrow('icon_models');"><b>Saved Pipelines</b><i id="icon_models" class="w3-right fa fa-angle-up" style='font-size:20px'></i></button>
</div>
<br>

<div class="w3-container w3-show" id="visualizer">
    <div class="w3-container">
        <div class="w3-row">
            <div class="w3-col w3-display-container w3-light-gray" style="width: 20%; height: 400px;">
                <div class="w3-container" style="padding: 0px; height: 362px; overflow-y: hidden;">
                    <div class="w3-container w3-center"><h5><b>Filter by</b></h5></div>
                    <button class="w3-button w3-block w3-left-align" onclick="toggle_viz('accordion_01');toggle_arrow('icon_accordion_01');">Parameters <i id="icon_accordion_01" class="fa fa-angle-down" style='font-size:20px'></i></button>
                    <div id="accordion_01" class="w3-container w3-bar-block w3-border w3-hide parameters" style="width: 100%; max-height: 150px; overflow-y: auto; padding: 0px;"></div>
                    <button class="w3-button w3-block w3-left-align" onclick="toggle_viz('accordion_02');toggle_arrow('icon_accordion_02');">Metrics <i id="icon_accordion_02" class="fa fa-angle-down" style='font-size:20px'></i></button>
                    <div id="accordion_02" class="w3-container w3-bar-block w3-border w3-hide metrics" style="width: 100%; max-height: 150px; overflow-y: auto; padding: 0px;"></div>
                </div>
                <button class="w3-display-bottom w3-button w3-block w3-border" onclick="load_models()">Refresh</button>
            </div>
            <div class="w3-rest w3-center" style="height: 400px; overflow-y: auto;">
                <div class="w3-container models" id="models"></div>
            </div>
        </div>
    </div>
</div>

<hr id="header_02">
<br>

<div class="w3-container">
    <button class="w3-button w3-block" onclick="toggle_viz('editor'); toggle_arrow('icon_editor');"><b>Pipeline editor</b><i id="icon_editor" class="w3-right fa fa-angle-up" style='font-size:20px'></i></button>
</div>
<br>

<div class="w3-container w3-show" id="editor">
    <div id="sample">
        <div class="w3-container">
            <div id="workBench" class="w3-row">

                <div class="w3-col w3-light-gray" style="width: 20%;">
                    <button class="w3-button w3-block w3-border" onclick="document.getElementById('modal_02').style.display='block'">Load pipeline</button>
                     <div class="w3-border" id="myPaletteDiv" style="height: 600px;"></div>
                </div>

                <div class="w3-col w3-light-gray" id="diagram" style="width: 80%;">
                    <button class="w3-button w3-block w3-border w3-border-green w3-hover-border-gray w3-green" onclick="document.getElementById('modal_01').style.display='block'">Execute Pipeline</button>
                    <div class="w3-border" id="myDiagramDiv" style="height: 600px;"></div>
                    <!-- <button class="w3-button w3-block w3-border">Save pipeline to file</button> -->
                </div>

                <div class="w3-col debugger w3-hide" id="debugger" style="width: 40%; height: 600px;">
                    <div class="w3-container" id="debugger_scrollmenu" style="padding: 0px;height: 40px; white-space: nowrap; overflow: auto;"></div>
                    <div class="w3-container w3-border" id="debugger_models" style="height: 600px;"></div>
                </div>
            </div>
        </div>

        <br>

        <div class="w3-container">
            <button class="w3-button w3-block w3-left-align w3-light-gray" onclick="toggle_viz('selected_parts'); toggle_arrow('icon_params');">Parameters<i id="icon_params" class="w3-right fa fa-angle-down" style='font-size:20px'></i></button>
        </div>

        <div class="w3-container w3-hide" id="selected_parts">
            <br>
            <div class="w3-container">
                <div class="w3-container w3-border-bottom">Selected Part:</div>
                <div class="w3-container" id="myInspectorDiv"></div>
            </div>
        </div>

        <br>

        <div class="w3-container">
            <button class="w3-button w3-block w3-left-align w3-light-gray" onclick="toggle_viz('tracking_info'); toggle_arrow('icon_tracking');">Tracking<i id="icon_tracking" class="w3-right fa fa-angle-down" style='font-size:20px'></i></button>
        </div>

        <div class="w3-container w3-hide" id="tracking_info">
            <div id="tracking_filter_form" class="tracking_filter_form">
                <br>
                <div class="w3-container">
                    <div class="w3-container w3-border-bottom">Tracking filters:</div>
                    <ul class="w3-ul" id="tracking_filters">
                    </ul>
                </div>
                <br>
                <div class="w3-container">
                    <div class="w3-container w3-border-bottom">Add or remove tracking filter:</div>
                    <div class="w3-margin w3-row-padding">
                        <div class="w3-quarter">Id filter</div>
                        <div class="w3-quarter">
                            <input id="tracking_form_input_01" class="w3-input" type="number" min="0" placeholder="Id">
                        </div>
                        <div class="w3-quarter w3-right">
                            <button class="w3-button w3-block" onclick="add_filter('id')">Add</button>
                        </div>
                    </div>
                    <div class="w3-margin w3-row-padding">
                        <div class="w3-quarter">Id range filter</div>
                        <div class="w3-quarter">
                            <input id="tracking_form_input_02" class="w3-input" type="number" min="0" placeholder="From (inclusive)">
                        </div>
                        <div class="w3-quarter">
                            <input id="tracking_form_input_03" class="w3-input" type="number" min="0" placeholder="Until (not inclusive)">
                        </div>
                        <div class="w3-quarter w3-right">
                            <button class="w3-button w3-block" onclick="add_filter('id_range')">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <br>

        <div class="w3-container w3-hide">
            <!-- <div>
                <button id="SaveButton" onclick="save()">Save</button>
                <button onclick="load()">Load</button>
                Diagram Model saved in JSON format:
            </div>
            <table>
                <tr>
                    <td>Filename to Save As:</td>
                    <td>
                        <input id="inputFileNameToSaveAs">
                    </td>
                    <td>
                        <button onclick="saveTextAsFile()">Save Text to File</button>
                    </td>
                </tr>
            </table> -->
            <textarea id="mySavedModel" style="width:100%;height:300px">
                { "class": "go.GraphLinksModel",
                  "linkFromPortIdProperty": "fromPort",
                  "linkToPortIdProperty": "toPort",
                  "nodeDataArray": [
                 ],
                  "linkDataArray": [
                 ]}
            </textarea>
        </div>
    </div>
</div>

<br>
<hr id="header_03">
<br>

<div class="w3-container">
    <button class="w3-button w3-block" onclick="toggle_viz('output_viz'); toggle_arrow('icon_viz');"><b>Visualize output</b><i id="icon_viz" class="w3-right fa fa-angle-up" style='font-size:20px'></i></button>
</div>

<div class="w3-container w3-center w3-margin w3-show" id="output_viz">
    <div class="w3-row" id="edv_div" style="height: 600px;">
        <div class="w3-quarter w3-hide" id="edv_list_div" style="height: 600px; overflow-y: auto;">
            <ul class="w3-ul w3-left w3-left-align" id="edv_list">
            </ul>
        </div>
        <div class="w3-rest" id="edv_iframe_div">
            <div class="dragscroll" id="myDiv" style="overflow: hidden; border: solid 1px black; background-color: white; width: 100%; height: 600px">
                <iframe name="myIframeName" id="iframeViz" width="0" height="0" scrolling="no" style="pointer-events: none; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<br>

<!-- Execute pipeline modal -->
<div id="modal_01" class="w3-modal">
    <div class="w3-modal-content w3-animate-top">
        <div class="w3-container w3-green"> 
            <h4>Execute pipeline<i onclick="document.getElementById('modal_01').style.display='none'" class="w3-button w3-right fa fa-times"></i></h4>
        </div>
        <div class="w3-container">
            <br>
            <div class="w3-container">Execution type</div>
            <div class="w3-row-padding">
                <div class="w3-quarter">
                    <input class="w3-radio" type="radio" name="debug_type" value="no_split" checked>
                    <label>No split</label>
                </div>
                <div class="w3-quarter">
                    <input class="w3-radio" type="radio" name="debug_type" value="clean">
                    <label>Clean</label>
                </div>
                <div class="w3-quarter">
                    <input class="w3-radio" type="radio" name="debug_type" value="dirty">
                    <label>Dirty</label>
                </div>
            </div>
            <br>
            <hr>
            <div class="w3-row-padding">
                <div class="w3-quarter w3-right">
                    <button class="w3-button w3-block w3-left-align w3-border" onclick="document.getElementById('modal_01').style.display='none';">Cancel</button>
                </div>
                <div class="w3-quarter w3-right">
                    <button class="w3-button w3-block w3-left-align w3-border w3-border-green w3-hover-border-gray w3-green" onclick="send();document.getElementById('modal_01').style.display='none';">Start</button>
                </div>
            </div>
            <br>
        </div>
    </div>
</div>

<!-- Load pipeline modal -->
<div id="modal_02" class="w3-modal">
    <div class="w3-modal-content w3-animate-top">
        <div class="w3-container w3-green"> 
            <h4>Load pipeline pipeline<i onclick="document.getElementById('modal_02').style.display='none'" class="w3-button w3-right fa fa-times"></i></h4>
        </div>
        <div class="w3-container">
            <br>
            <div class="w3-container">Load pre-defined pipeline</div>
            <br>
            <div class="w3-container">
                <div class="w3-bar">
                    <button class="w3-bar-item w3-button w3-border" onclick="request_pipeline('main_A');document.getElementById('modal_02').style.display='none'">main_A</button>
                    <button class="w3-bar-item w3-button w3-border" onclick="request_pipeline('main_B');document.getElementById('modal_02').style.display='none'">main_B</button>
                    <button class="w3-bar-item w3-button w3-border" onclick="request_pipeline('main_C');document.getElementById('modal_02').style.display='none'">main_C</button>
                    <button class="w3-bar-item w3-button w3-border" onclick="request_pipeline('main_D');document.getElementById('modal_02').style.display='none'">main_D</button>
                    <button class="w3-bar-item w3-button w3-border" onclick="request_pipeline('main_E');document.getElementById('modal_02').style.display='none'">main_E</button>
                    <button class="w3-bar-item w3-button w3-border" onclick="request_pipeline('main_F');document.getElementById('modal_02').style.display='none'">main_F</button>
                </div>
            </div>
            <br>
            <div class="w3-container">Load pipeline from file</div>
            <br>
            <div class="w3-container">
            <input type="file" id="input" class="form-control-file" onchange="handleFile(this.files);document.getElementById('modal_02').style.display='none'">
            </div>
            <br>
            <hr>
            <div class="w3-row-padding">
                <div class="w3-quarter w3-right">
                    <button class="w3-button w3-block w3-left-align w3-border" onclick="document.getElementById('modal_02').style.display='none';">Close</button>
                </div>
            </div>
            <br>
        </div>
    </div>
</div>


<!-- <div class="global_div">
    <div id="editor" style="float: left; width: 100%;">
        <div style="width: 100%">
            <div class="btn-group">
                <h4>Load pre-defined pipelines</h4>
                <button type="button" class="btn btn-default" onclick="request_pipeline('main_A')">main_A</button>
                <button type="button" class="btn btn-default" onclick="request_pipeline('main_B')">main_B</button>
                <button type="button" class="btn btn-default" onclick="request_pipeline('main_C')">main_C</button>
                <button type="button" class="btn btn-default" onclick="request_pipeline('main_D')">main_D</button>
                <button type="button" class="btn btn-default" onclick="request_pipeline('main_E')">main_E</button>
                <button type="button" class="btn btn-default" onclick="request_pipeline('main_F')">main_F</button>
                <button type="button" class="btn btn-success" onclick="send('no_split')">Execute no split</button>
                <button type="button" class="btn btn-success" onclick="send('clean')">Execute clean</button>
                <button type="button" class="btn btn-success" onclick="send('dirty')">Execute dirty</button>
            </div>
            <div>
                <h4>Load pipeline from file</h4>
                <div>
                    <input type="file" id="input" class="form-control-file" onchange="handleFile(this.files)">
                    <br>
                    <button id="open_visualizer" type="button" class="btn btn-default" onclick="open_visualizer()" style="display: initial;">Open Visualizer</button>
                    <button id="close_visualizer" type="button" class="btn btn-default" onclick="close_visualizer()" style="display: none;">Close Visualizer</button>
                    <button id="open_debugger" type="button" class="btn btn-default" onclick="open_debugger()" style="display: initial;">Open Debugger</button>
                    <button id="close_debugger" type="button" class="btn btn-default" onclick="close_debugger()" style="display: none;">Close Debugger</button>
                </div>
            </div>
        </div>
        <br>
        <div id="tracking_info">
            <div id="tracking_filter_form" class="tracking_filter_form">
                <h2>Add or remove tracking filter</h2>
                <div>Filter Type:</div>
                <select id="tracking_filter_options" onchange="showAppropriateForm(this.value);">
                    <option value="id">Id</option>
                    <option value="id_range">Id range</option>
                </select>
                <div id="tracking_form_inputs">
                    <input type="number" required name="tr_id" class="tracking_form_elem" style="display: inline-block;" placeholder="id"></input>
                    <input type="number" required name="tr_id_start" class="tracking_form_elem" style="display: none;" placeholder="from (inclusive)"></input>
                    <input type="number" required name="tr_id_end" class="tracking_form_elem" style="display: none;" placeholder="until (not inclusive)"></input>
                </div>
                <span onclick="newElement()" class="addBtn">Add</span>
            </div>
            <div>Tracking filters</div>
            <ul id="tracking_filters">
            </ul>
        </div>
        <br>
        <div id="sample">
            <div id="workBench" style="width: 100%; display: flex; justify-content: space-between">
                <div id="myPaletteDiv"
                     style="width: 20%; margin-right: 2px; background-color: white; border: solid 1px black"></div>
                <div id="myDiagramDiv" style="flex-grow: 0; margin-right: 2px; height: 620px; width: 20%; border: solid 1px black"></div>
                    <div id="myDiv" class="dragscroll" style="overflow: hidden; border: solid 1px black; background-color: white; width: 60%; height: 620px">
                        <iframe name="myIframeName" id="iframeViz" width="0" height="0" scrolling="no" style="pointer-events: none; border: none;"></iframe>
                    </div>
            </div>
            <span style="display: inline-block; vertical-align: top;">
                    Selected Part:<br/>
                    <div id="myInspectorDiv" class="inspector"> </div><br/>
                </span>
            <div>
                <div>
                    <button id="SaveButton" onclick="save()">Save</button>
                    <button onclick="load()">Load</button>
                    Diagram Model saved in JSON format:
                </div>
                <table>
                    <tr>
                        <td>Filename to Save As:</td>
                        <td><input id="inputFileNameToSaveAs"></input></td>
                        <td>
                            <button onclick="saveTextAsFile()">Save Text to File</button>
                        </td>
                    </tr>
                </table>
                <textarea id="mySavedModel" style="width:100%;height:300px">
        { "class": "go.GraphLinksModel",
          "linkFromPortIdProperty": "fromPort",
          "linkToPortIdProperty": "toPort",
          "nodeDataArray": [
         ],
          "linkDataArray": [
         ]}
            </textarea>
            </div>
        </div>
    </div>
    <div id="visualizer" class="visualizer">
        <div id="model_table" class="model_table">
            <div class="models_headings">
                <div class="model_heading heading_models">
                    <button class="dropbtn" disabled="">Models</button>
                </div>
                <div class="model_heading heading_parameters dropdown">
                    <div class="dropdown-container" style="width: 100%;">
                        <button class="dropbtn">Parameter filter</button>
                        <div class="parameters dropdown-content"></div>
                    </div>
                </div>
                <div class="model_heading heading_parameters dropdown">
                    <div class="dropdown-container" style="width: 100%;">
                        <button class="dropbtn">Metrics filter</button>
                        <div class="metrics dropdown-content"></div>
                    </div>
                </div>
            </div>
            <div class="models_container">
                <div id="models" class="models"></div>
            </div>
        </div>
    </div>
    <div id="debugger" class="debugger">
        <div class="debugger_container">
            <div id="debugger_scrollmenu" class="debugger_scrollmenu"></div>
            <div id="debugger_models" class="debugger_models"></div>
        </div>
    </div>
</div> -->
</body>

</html>
